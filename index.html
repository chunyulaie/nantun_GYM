<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台中市各運動中心｜人流</title>

  <!-- Luxon + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <!-- Annotation 插件：用來畫上限虛線 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
  <!-- 解析 Google Sheet CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --accent:#2563eb; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; }
    .wrap { max-width:1100px; margin:32px auto; padding:0 16px; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1 { margin:0 0 6px; font-weight:700; letter-spacing:.5px; }
    .sub { color:var(--muted); margin:0 0 12px; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0 18px; align-items:center; }
    .pill { padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1); font-size:14px; }
    .footer { color:var(--muted); font-size:13px; margin-top:10px; }
    a { color:#60a5fa; text-decoration:none; } a:hover{ text-decoration:underline; }
    .chart-wrap{ height:420px; position:relative; }
    canvas{ position:absolute; inset:0; width:100% !important; height:100% !important; display:block; }

    select, label { font-size:14px; }
    .select {
      padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:var(--fg);
      appearance:auto;
    }
    .select option { background:#fff; color:#000; }
    #seriesToggles label { display:inline-flex; align-items:center; gap:6px; cursor:pointer; }
    #seriesToggles input[type="checkbox"]{ width:16px; height:16px; accent-color:#60a5fa; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="pageTitle">南屯運動中心｜人流</h1>
      <p class="sub">來源：Google Sheet（CSV / all_centers 分頁）→ Chart.js（定時更新） · 固定只顯示 06:00–22:00</p>

      <div class="row">
        <!-- 顯示 x/上限 與 % -->
        <span class="pill">游泳池 <b id="poolNow">—</b> / <span id="poolMax">—</span> 人（<span id="poolPct">—%</span>）</span>
        <span class="pill">健身房 <b id="gymNow">—</b> / <span id="gymMax">—</span> 人（<span id="gymPct">—%</span>）</span>
        <span class="pill">最後更新：<span id="lastUpd">—</span></span>
      </div>

      <div class="row" style="margin-top:0;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div>
            <label for="centerSel" style="margin-right:6px;">運動中心：</label>
            <select id="centerSel" class="select">
              <option value="" disabled selected>載入中…</option>
            </select>
          </div>
          <div>
            <label for="dateSel" style="margin-right:6px;">日期：</label>
            <select id="dateSel" class="select">
              <option value="" disabled selected>載入中…</option>
            </select>
          </div>
        </div>
        <div id="seriesToggles" style="display:flex; gap:12px; align-items:center; color:var(--fg)">
          <label><input type="checkbox" value="pool" checked> 游泳池</label>
          <label><input type="checkbox" value="gym" checked> 健身房</label>
        </div>
      </div>

      <div class="chart-wrap"><canvas id="chart"></canvas></div>

      <div class="footer">
        只統計每日 06:00–22:00 · 每 <span id="freqText">600</span> 秒自動更新 ·
        <a id="csvLink" target="_blank" rel="noopener">查看 CSV</a>
      </div>
    </div>
  </div>

  <script>
    // === 設定 ===
    const DEFAULT_CENTER = '南屯運動中心';
    const SHEET_GID_ALL_CENTERS = '840629068'; // all_centers 分頁 gid
    const CSV_BASE = "https://docs.google.com/spreadsheets/d/1dc9bQyHppywqpy82E-OIV4HYoXFgTcXbxNexlV4_5dE/export?format=csv";
    const REFRESH_MS = 600_000; // 10 分鐘
    const DAY_START = 6;  // 06:00
    const DAY_END   = 22; // 到 22:59 都算（含 22）

    // 各中心上限（無上限填 null）
    const CAPACITY = {
      '南屯運動中心': { pool: 200, gym: 120 },
      '北區運動中心': { pool: 480, gym: 180 },
      '朝馬運動中心': { pool: 180, gym: 90 },
      '大里運動中心': { pool: 160, gym: 140 },
      '潭子運動中心': { pool: 200, gym: 90 },
      '長春運動中心': { pool: 200, gym: 150 },
      '沙鹿運動中心': { pool: null, gym: 90 },
      '港區運動中心': { pool: null, gym: 100 },
      '豐原運動中心': { pool: 180, gym: 65 },
    };

    function csvUrl() {
      const u = new URL(CSV_BASE);
      u.searchParams.set('gid', SHEET_GID_ALL_CENTERS);
      u.searchParams.set('_ts', Date.now()); // 防快取
      return u.toString();
    }
    document.getElementById('csvLink').href = csvUrl();
    document.getElementById('freqText').textContent = Math.round(REFRESH_MS/1000);

    // 解析台北時區時間（支援多種格式）
    function parseTWDateMs(tStr) {
      const opts = { locale: 'zh-TW', zone: 'Asia/Taipei' };
      const s = (tStr || '').toString().trim();
      if (!s) return NaN;
      let dt;
      dt = luxon.DateTime.fromFormat(s, 'yyyy-MM-dd HH:mm:ss', opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(s, 'yyyy-MM-dd HH:mm',    opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(s, 'yyyy/M/d HH:mm:ss',   opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(s, 'yyyy/M/d HH:mm',      opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(s, 'yyyy/M/d a h:mm:ss',  opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(s, 'yyyy/M/d a h:mm',     opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(s, 'yyyy.MM.dd HH:mm:ss', opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(s, 'yyyy.MM.dd HH:mm',    opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromISO(s, { zone: 'Asia/Taipei' });        if (dt.isValid) return dt.toMillis();
      const t = Date.parse(s);
      return Number.isNaN(t) ? NaN : t;
    }

    // 欄位對應（容錯多種命名 + 去掉 BOM）
    function pick(obj, keysRegex) {
      for (const k of Object.keys(obj)) {
        const nk = k.replace(/\ufeff/g,'').trim();
        if (keysRegex.test(nk)) return obj[k];
      }
      return undefined;
    }
    const RX_TIME   = /(時間|timestamp)/i;
    const RX_CENTER = /(中心|運動中心|館|場館|館別|中心名稱|center)/i;
    const RX_POOL   = /(游泳池|pool|swim)/i;
    const RX_GYM    = /(健身|健身房|gym|weight)/i;

    /** @type {{t:number, center:string, pool:number|null, gym:number|null, isoDate:string}[]} */
    let rows = [];
    let currentCenter = DEFAULT_CENTER;  // 預設南屯
    let currentIsoDate = '';             // 例如 '2025-08-14'

    // ====== 自訂動畫插件（藤蔓生成）======
    const VineRevealPlugin = {
      id: 'vineReveal',
      duration: 2500,
      afterInit(chart) { this.restart(chart); },
      restart(chart) {
        if (chart.$vineRAF) cancelAnimationFrame(chart.$vineRAF);
        chart.$vineStart = performance.now();
        chart.$vineProgress = 0;
        const tick = () => {
          const now = performance.now();
          const t = Math.min(1, (now - chart.$vineStart) / (this.duration || 2500));
          chart.$vineProgress = t;
          chart.draw();
          if (t < 1) chart.$vineRAF = requestAnimationFrame(tick);
        };
        chart.$vineRAF = requestAnimationFrame(tick);
      },
      beforeDatasetsDraw(chart) {
        const t = chart.$vineProgress ?? 1;
        if (t >= 1) return;
        const {ctx, chartArea} = chart;
        const ease = 1 - Math.pow(1 - t, 3);
        const w = chartArea.right - chartArea.left;
        const h = chartArea.bottom - chartArea.top;
        ctx.save();
        ctx.beginPath();
        ctx.rect(chartArea.left, chartArea.top, w * ease, h);
        ctx.clip();
        ctx.globalAlpha = 0.4 + 0.6 * ease;
        chart.$vineClipped = true;
      },
      afterDatasetsDraw(chart) {
        if (chart.$vineClipped) {
          chart.ctx.restore();
          chart.$vineClipped = false;
        }
      },
      destroy(chart) {
        if (chart.$vineRAF) cancelAnimationFrame(chart.$vineRAF);
      }
    };
    Chart.register(VineRevealPlugin);
    // 註冊 annotation 插件（CDN 會暴露為全域 ChartAnnotation）
    Chart.register(window.ChartAnnotation || window['chartjs-plugin-annotation']);

    async function fetchCSV() {
      const res = await fetch(csvUrl(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();

      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      if (parsed.errors?.length) console.warn('CSV parse warnings:', parsed.errors.slice(0,3));

      const tmp = [];
      for (const r of parsed.data) {
        const tStr   = (pick(r, RX_TIME)   ?? '').toString().trim();
        const center = (pick(r, RX_CENTER) ?? '').toString().trim();

        // 嚴謹的數字處理：非數字則記為 null（避免把空字串誤當 0）
        const poolRaw = (pick(r, RX_POOL) ?? '').toString().trim();
        const gymRaw  = (pick(r, RX_GYM)  ?? '').toString().trim();
        const poolNum = Number(poolRaw);  const pool = Number.isFinite(poolNum) ? poolNum : null;
        const gymNum  = Number(gymRaw);   const gym  = Number.isFinite(gymNum)  ? gymNum  : null;

        const t = parseTWDateMs(tStr);
        if (!center || Number.isNaN(t)) continue;

        const dt = luxon.DateTime.fromMillis(t).setZone('Asia/Taipei');
        const h  = dt.hour;
        if (h < DAY_START || h > DAY_END) continue;  // 只看 06–22
        const isoDate = dt.toISODate();

        tmp.push({ t, center, pool, gym, isoDate });
      }
      tmp.sort((a,b)=>a.t-b.t);
      rows = tmp;

      rebuildCenterSelect();
      rebuildDateSelect();
      ensureDefaults();
      updateHeading();
    }

    function rebuildCenterSelect() {
      const centers = Array.from(new Set(rows.map(r=>r.center))).filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      const sel = document.getElementById('centerSel');
      if (centers.length === 0) {
        sel.innerHTML = `<option value="" disabled selected>（找不到資料）</option>`;
        return;
      }
      sel.innerHTML = centers.map(c=>`<option value="${c}">${c}</option>`).join('');
      if (!centers.includes(currentCenter)) currentCenter = centers[0];
      sel.value = currentCenter;
    }

    function rebuildDateSelect() {
      const dates = Array.from(new Set(rows.filter(r=>r.center===currentCenter).map(r=>r.isoDate)))
        .sort((a,b)=> b.localeCompare(a)); // 新→舊
      const sel = document.getElementById('dateSel');
      if (dates.length === 0) {
        sel.innerHTML = `<option value="" disabled selected>（此中心無資料）</option>`;
        currentIsoDate = '';
        return;
      }
      sel.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
      if (!dates.includes(currentIsoDate)) currentIsoDate = dates[0];
      sel.value = currentIsoDate;
    }

    function ensureDefaults() {
      if (!currentCenter) {
        const any = rows[0]?.center;
        if (any) currentCenter = any;
      }
      if (!currentIsoDate) {
        const any = rows.find(r=>r.center===currentCenter)?.isoDate;
        if (any) currentIsoDate = any;
      }
    }

    // 依中心 + 日期切片；07:00~22:00 若兩邊都「缺或為 0」則排除
    function sliceForChart() {
      const filtered = rows.filter(r => {
        if (r.center !== currentCenter || r.isoDate !== currentIsoDate) return false;
        const hour = luxon.DateTime.fromMillis(r.t).setZone('Asia/Taipei').hour;
        if (hour >= 7 && hour <= 22) {
          const poolZeroOrMissing = (r.pool == null) || (r.pool === 0);
          const gymZeroOrMissing  = (r.gym  == null) || (r.gym  === 0);
          if (poolZeroOrMissing && gymZeroOrMissing) return false;
        }
        if (r.center === '港區運動中心' && r.gym === 100) return false; // 過濾異常值
        return true;
      });

      return {
        times: filtered.map(r=>r.t),
        pool:  filtered.map(r=> (Number.isFinite(r.pool) ? r.pool : null)),
        gym:   filtered.map(r=> (Number.isFinite(r.gym)  ? r.gym  : null)),
      };
    }

    // 更新頁面主標題
    function updateHeading() {
      const h1 = document.getElementById('pageTitle');
      h1.textContent = currentCenter ? `${currentCenter}｜人流` : `台中市各運動中心｜人流`;
    }

    let chart;
    function initChart() {
      if (chart) return chart;
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [
          {
            label: '游泳池人數',
            data: [],
            borderWidth: 3,
            tension: 0.5,
            pointRadius: 2,
            pointHoverRadius: 6,
            borderCapStyle: 'round',
            borderJoinStyle: 'round',
            borderColor: 'rgba(99,102,241,1)',      // indigo
            backgroundColor: 'rgba(99,102,241,0.15)',
            fill: 'origin'
          },
          {
            label: '健身房人數',
            data: [],
            borderWidth: 3,
            tension: 0.35,
            pointRadius: 2,
            pointHoverRadius: 6,
            borderCapStyle: 'round',
            borderJoinStyle: 'round',
            borderColor: 'rgba(16,185,129,1)',      // emerald
            backgroundColor: 'rgba(16,185,129,0.15)',
            fill: 'origin'
          }
        ]},
        options: {
          responsive: true, maintainAspectRatio: false,
          interaction: { mode:'nearest', intersect:false },
          animation: { duration: 700, easing: 'easeOutQuart' },
          plugins: {
            legend: { labels: { color:'#e5e7eb' } },
            tooltip: { callbacks: {
              title: (items) => items.length
                ? luxon.DateTime.fromMillis(items[0].parsed.x).setZone('Asia/Taipei').toFormat('yyyy-MM-dd HH:mm:ss')
                : ''
            }},
            annotation: {
              annotations: {
                poolCap: {
                  type: 'line',
                  yMin: 0, yMax: 0,
                  display: false,
                  borderColor: 'rgba(99,102,241,.6)',
                  borderWidth: 1,
                  borderDash: [6,6],
                  label: {
                    display: true,
                    content: '泳池上限',
                    position: 'start',
                    backgroundColor: 'rgba(99,102,241,.15)',
                    color: '#e5e7eb'
                  }
                },
                gymCap: {
                  type: 'line',
                  yMin: 0, yMax: 0,
                  display: false,
                  borderColor: 'rgba(16,185,129,.6)',
                  borderWidth: 1,
                  borderDash: [6,6],
                  label: {
                    display: true,
                    content: '健身房上限',
                    position: 'start',
                    backgroundColor: 'rgba(16,185,129,.15)',
                    color: '#e5e7eb'
                  }
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              adapters: { date: { zone: 'Asia/Taipei' } },
              time: {
                unit: 'hour',
                stepSize: 1,
                displayFormats: { hour: 'HH:mm', minute: 'HH:mm' },
                tooltipFormat: 'HH:mm'
              },
              ticks: {
                color: '#e5e7eb',
                autoSkip: true, maxRotation: 0, minRotation: 0, maxTicksLimit: 10,
                callback: (val) => luxon.DateTime.fromMillis(val).setZone('Asia/Taipei').toFormat('HH:mm')
              },
              grid: { color: 'rgba(255,255,255,.08)' },
              border: { color: 'rgba(255,255,255,.15)' }
            },
            y: {
              beginAtZero: true,
              suggestedMax: 10,
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(255,255,255,.08)' },
              title: { display: true, text: '人數', color: '#e5e7eb' },
              border: { color: 'rgba(255,255,255,.15)' }
            }
          }
        }
      });
      return chart;
    }

    // 讀目前勾選了哪些序列
    function getCheckedSeries() {
      return new Set(
        Array.from(document.querySelectorAll('#seriesToggles input:checked'))
             .map(cb => cb.value) // 'pool' | 'gym'
      );
    }

    // 依勾選狀態，動態設定 Y 軸上限與上限虛線顯示
    function updateYAxisAndCaps(chart, poolData, gymData) {
      const checked = getCheckedSeries();

      // 當前中心的上限
      const cap = CAPACITY[currentCenter] || {};
      const poolCap = Number.isFinite(cap.pool) ? cap.pool : null;
      const gymCap  = Number.isFinite(cap.gym)  ? cap.gym  : null;

      // 只取「可見」資料與上限來決定刻度
      const parts = [0]; // 保底
      if (checked.has('pool')) {
        parts.push(...(poolData || []).filter(Number.isFinite));
        if (poolCap != null) parts.push(poolCap);
      }
      if (checked.has('gym')) {
        parts.push(...(gymData || []).filter(Number.isFinite));
        if (gymCap != null) parts.push(gymCap);
      }

      const dataMax = parts.length ? Math.max(...parts) : 0;
      const yMax = dataMax > 0 ? Math.ceil(dataMax * 1.1) : 10;
      chart.options.scales.y.suggestedMax = yMax;

      // 上限虛線：只有被勾選的才顯示
      const anns = chart.options.plugins?.annotation?.annotations;
      if (anns) {
        if (checked.has('pool') && poolCap != null) {
          anns.poolCap.display = true;
          anns.poolCap.yMin = anns.poolCap.yMax = poolCap;
          anns.poolCap.label.content = `泳池上限 ${poolCap}`;
        } else {
          anns.poolCap.display = false;
        }

        if (checked.has('gym') && gymCap != null) {
          anns.gymCap.display = true;
          anns.gymCap.yMin = anns.gymCap.yMax = gymCap;
          anns.gymCap.label.content = `健身房上限 ${gymCap}`;
        } else {
          anns.gymCap.display = false;
        }
      }
    }

    // 勾選框控制可見度（並重算上限）
    function applyCheckboxVisibility() {
      if (!chart) return;
      const checked = Array.from(document.querySelectorAll('#seriesToggles input:checked'))
                           .map(cb => cb.value);
      chart.data.datasets[0].hidden = !checked.includes('pool'); // 泳池
      chart.data.datasets[1].hidden = !checked.includes('gym');  // 健身

      // 依最新勾選狀態重算 Y 軸與上限虛線
      updateYAxisAndCaps(chart, chart.data.datasets[0].data, chart.data.datasets[1].data);

      chart.update('none');
    }

    function lastFinite(arr) {
      for (let i = arr.length - 1; i >= 0; i--) if (Number.isFinite(arr[i])) return arr[i];
      return null;
    }

    function applyAndRender() {
      const c = initChart();
      const { times, pool, gym } = sliceForChart();

      c.data.labels = times;
      c.data.datasets[0].data = pool;
      c.data.datasets[1].data = gym;

      // 重新啟動動畫
      const plugin = Chart.registry.getPlugin('vineReveal');
      if (plugin && typeof plugin.restart === 'function') plugin.restart(c);

      // 依勾選狀態計算 Y 軸與上限虛線
      updateYAxisAndCaps(c, c.data.datasets[0].data, c.data.datasets[1].data);

      // 套用更新
      c.update('none');

      // 更新頁面 pill 數字與時間
      if (times.length) {
        document.getElementById('lastUpd').textContent =
          luxon.DateTime.fromMillis(times[times.length-1]).setZone('Asia/Taipei').toFormat('yyyy-MM-dd HH:mm:ss');
      } else {
        document.getElementById('lastUpd').textContent = '—';
      }

      const poolNow = lastFinite(pool);
      const gymNow  = lastFinite(gym);
      document.getElementById('poolNow').textContent = (poolNow != null) ? poolNow : '—';
      document.getElementById('gymNow').textContent  = (gymNow  != null) ? gymNow  : '—';

      const cap = CAPACITY[currentCenter] || {};
      const poolCap = Number.isFinite(cap.pool) ? cap.pool : null;
      const gymCap  = Number.isFinite(cap.gym)  ? cap.gym  : null;

      const nf = new Intl.NumberFormat('zh-TW');
      const showPct = (now, cap) => (cap > 0 && now != null) ? `${Math.round((now / cap) * 100)}%` : '—%';

      document.getElementById('poolMax').textContent = (poolCap != null) ? nf.format(poolCap) : '—';
      document.getElementById('gymMax').textContent  = (gymCap  != null) ? nf.format(gymCap)  : '—';
      document.getElementById('poolPct').textContent = (poolCap != null) ? showPct(poolNow, poolCap) : '—%';
      document.getElementById('gymPct').textContent  = (gymCap  != null) ? showPct(gymNow,  gymCap)  : '—%';
    }

    async function refresh() {
      try {
        await fetchCSV();
        applyAndRender();
        document.getElementById('csvLink').href = csvUrl(); // 更新附帶 _ts 的 CSV 連結
      } catch (e) {
        console.error(e);
      }
    }

    // 綁定 UI
    document.getElementById('centerSel').addEventListener('change', (e)=>{
      currentCenter = e.target.value;
      updateHeading();
      rebuildDateSelect();
      applyAndRender();
    });
    document.getElementById('dateSel').addEventListener('change', (e)=>{
      currentIsoDate = e.target.value;
      applyAndRender();
    });
    document.getElementById('seriesToggles').addEventListener('change', applyCheckboxVisibility);

    // 初始化
    currentCenter = DEFAULT_CENTER;
    updateHeading();
    initChart();
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
