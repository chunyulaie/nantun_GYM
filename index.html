<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台中市各運動中心｜每日人數</title>

  <!-- Luxon + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <!-- 解析 Google Sheet CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --accent:#2563eb; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; }
    .wrap { max-width:1100px; margin:32px auto; padding:0 16px; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1 { margin:0 0 6px; font-weight:700; letter-spacing:.5px; }
    .sub { color:var(--muted); margin:0 0 12px; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0 18px; align-items:center; }
    .pill { padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1); font-size:14px; }
    .footer { color:var(--muted); font-size:13px; margin-top:10px; }
    a { color:#60a5fa; text-decoration:none; } a:hover{ text-decoration:underline; }
    .chart-wrap{ height:420px; position:relative; }
    canvas{ position:absolute; inset:0; width:100% !important; height:100% !important; display:block; }
    select, label { font-size:14px; }
    .select {
      padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:var(--fg);
      appearance:auto;
    }
    .select option { background:#fff; color:#000; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="pageTitle">南屯運動中心｜每日人數</h1>
      <p class="sub">來源：Google Sheet（CSV 發佈 / all_centers 分頁）→ Chart.js（定時更新） · 固定只顯示 06:00–22:00</p>

      <div class="row">
        <span class="pill">游泳池 <b id="poolNow">—</b> 人</span>
        <span class="pill">健身房 <b id="gymNow">—</b> 人</span>
        <span class="pill">最後更新：<span id="lastUpd">—</span></span>
      </div>

      <div class="row" style="margin-top:0;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div>
            <label for="centerSel" style="margin-right:6px;">運動中心：</label>
            <select id="centerSel" class="select"><option value="" disabled selected>載入中…</option></select>
          </div>
          <div>
            <label for="dateSel" style="margin-right:6px;">日期：</label>
            <select id="dateSel" class="select"><option value="" disabled selected>載入中…</option></select>
          </div>
        </div>
      </div>

      <div class="chart-wrap"><canvas id="chart"></canvas></div>

      <div class="footer">
        只統計每日 06:00–22:00 · 每 <span id="freqText">600</span> 秒自動更新 ·
        <a id="csvLink" target="_blank" rel="noopener">查看 CSV</a>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_CENTER = '南屯運動中心';
    const SHEET_GID_ALL_CENTERS = '840629068';
    const CSV_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTT8SPXPZk3LL7gyCkJclb2gjZ2OGMxfWvwuPmXR11c5P7IQ3Q1G6TDgz-X35ZuFqyVXViU50ZakONq/pub?output=csv";
    const REFRESH_MS = 600_000;
    const DAY_START = 6, DAY_END = 22;

    function csvUrl() {
      const u = new URL(CSV_BASE);
      u.searchParams.set('gid', SHEET_GID_ALL_CENTERS);
      u.searchParams.set('_ts', Date.now());
      return u.toString();
    }
    document.getElementById('csvLink').href = csvUrl();
    document.getElementById('freqText').textContent = Math.round(REFRESH_MS/1000);

    function parseTWDateMs(tStr) {
      const opts = { locale: 'zh-TW', zone: 'Asia/Taipei' };
      let dt;
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy-MM-dd HH:mm:ss', opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy-MM-dd HH:mm', opts);    if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d HH:mm:ss', opts);   if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d HH:mm', opts);      if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d a h:mm:ss', opts);  if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d a h:mm', opts);     if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromISO(tStr, { zone: 'Asia/Taipei' });        if (dt.isValid) return dt.toMillis();
      return NaN;
    }

    function pick(obj, keysRegex) {
      for (const k of Object.keys(obj)) {
        const nk = k.replace(/\ufeff/g,'').trim();
        if (keysRegex.test(nk)) return obj[k];
      }
      return undefined;
    }
    const RX_TIME   = /(時間|timestamp)/i;
    const RX_CENTER = /(中心|運動中心|館|場館|館別|中心名稱|center)/i;
    const RX_POOL   = /(游泳池|pool|swim)/i;
    const RX_GYM    = /(健身|健身房|gym|weight)/i;

    let rows = [], currentCenter = DEFAULT_CENTER, currentIsoDate = '';

    const VineRevealPlugin = { /* 原藤蔓插件略，同前版本 */ };

    const yTitleVertical = {
      id: 'yTitleVertical',
      afterDraw(chart, args, opts) {
        if (!opts?.enabled) return;
        const y = chart.scales?.y;
        if (!y) return;
        const { ctx, chartArea } = chart;
        const text = (opts.text ?? '人數').toString();
        const lines = text.split('');
        const color = opts.color || '#e5e7eb';
        const font = opts.font || '14px ui-sans-serif, system-ui, "Noto Sans TC", Arial';
        const gap = opts.gap ?? 4;
        const offset = opts.offset ?? 40; // 調大一點
        const cx = chartArea.left - offset;
        const cy = (chartArea.top + chartArea.bottom) / 2;
        ctx.save();
        ctx.fillStyle = color;
        ctx.font = font;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const metrics = ctx.measureText('字');
        const lineH = (metrics.actualBoundingBoxAscent || 8) +
                      (metrics.actualBoundingBoxDescent || 4) + gap;
        const totalH = lineH * lines.length - gap;
        let y0 = cy - totalH / 2;
        for (const ch of lines) {
          ctx.fillText(ch, cx, y0 + (lineH - gap) / 2);
          y0 += lineH;
        }
        ctx.restore();
      }
    };

    Chart.register(VineRevealPlugin, yTitleVertical);

    function initChart() {
      const ctx = document.getElementById('chart').getContext('2d');
      return new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [ /* 略，與原相同 */ ] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 50 } }, // 左邊留更多空間
          plugins: {
            legend: { labels: { color:'#e5e7eb' } },
            tooltip: { /* 與原相同 */ },
            yTitleVertical: { enabled:true, text:'人數', color:'#e5e7eb', offset:40, gap:4 }
          },
          scales: {
            x: { /* 與原相同 */ },
            y: { beginAtZero:true, ticks:{ color:'#e5e7eb' }, grid:{ color:'rgba(255,255,255,.08)' }, title:{ display:false } }
          }
        }
      });
    }
    // 其他 fetchCSV、applyAndRender 等程式碼與你原本相同
  </script>
</body>
</html>
