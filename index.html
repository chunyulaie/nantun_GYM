<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>台中市各運動中心｜每日人數</title>

  <!-- Luxon + Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <!-- 可靠解析 Google Sheet CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --accent:#2563eb; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; }
    .wrap { max-width:1100px; margin:32px auto; padding:0 16px; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.25); }
    h1 { margin:0 0 6px; font-weight:700; letter-spacing:.5px; }
    .sub { color:var(--muted); margin:0 0 12px; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0 18px; align-items:center; }
    .pill { padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1); font-size:14px; }
    .footer { color:var(--muted); font-size:13px; margin-top:10px; }
    a { color:#60a5fa; text-decoration:none; } a:hover{ text-decoration:underline; }
    .chart-wrap{ height:420px; position:relative; }
    canvas{ position:absolute; inset:0; width:100% !important; height:100% !important; display:block; }

    select, label { font-size:14px; }
    .select {
      padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06); color:var(--fg);
      appearance:auto;
    }
    .select:disabled { opacity:.5; cursor:not-allowed; }
    .select option { background:#fff; color:#000; } /* 展開列表白底黑字，避免看不到 */

    /* 小開關 */
    .switch {
      display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
      padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
    }
    .switch input { appearance:none; width:36px; height:20px; background:#4b5563; border-radius:999px; position:relative; outline:none; transition:.2s; }
    .switch input:checked { background:#22c55e; }
    .switch input::after {
      content:''; position:absolute; top:2px; left:2px; width:16px; height:16px; border-radius:50%; background:#fff; transition:.2s;
    }
    .switch input:checked::after { left:18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="pageTitle">南屯運動中心｜每日人數</h1>
      <p class="sub">來源：Google Sheet（CSV 發佈 / all_centers 分頁）→ Chart.js（定時更新） · 固定只顯示 06:00–22:00</p>

      <div class="row">
        <span class="pill">游泳池 <b id="poolNow">—</b> 人</span>
        <span class="pill">健身房 <b id="gymNow">—</b> 人</span>
        <span class="pill">最後更新：<span id="lastUpd">—</span></span>
      </div>

      <div class="row" style="margin-top:0;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div>
            <label for="centerSel" style="margin-right:6px;">運動中心：</label>
            <select id="centerSel" class="select">
              <option value="" disabled selected>載入中…</option>
            </select>
          </div>
          <div>
            <label for="dateSel" style="margin-right:6px;">日期：</label>
            <select id="dateSel" class="select">
              <option value="" disabled selected>載入中…</option>
            </select>
          </div>

          <!-- 新增：全部中心切換與指標選擇 -->
          <label class="switch" title="將同一天的所有中心疊在同一張圖上">
            <input type="checkbox" id="allMode">
            <span>顯示全部中心</span>
          </label>
          <div id="metricBox" style="display:none;">
            <label for="metricSel" style="margin-right:6px;">指標：</label>
            <select id="metricSel" class="select">
              <option value="pool">游泳池</option>
              <option value="gym">健身房</option>
            </select>
          </div>
        </div>
      </div>

      <div class="chart-wrap"><canvas id="chart"></canvas></div>

      <div class="footer">
        只統計每日 06:00–22:00 · 每 <span id="freqText">600</span> 秒自動更新 ·
        <a id="csvLink" target="_blank" rel="noopener">查看 CSV</a>
      </div>
    </div>
  </div>

  <script>
    // === 設定 ===
    const DEFAULT_CENTER = '南屯運動中心';        // 預設顯示
    const SHEET_GID_ALL_CENTERS = '840629068';    // all_centers 的 gid
    const CSV_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTT8SPXPZk3LL7gyCkJclb2gjZ2OGMxfWvwuPmXR11c5P7IQ3Q1G6TDgz-X35ZuFqyVXViU50ZakONq/pub?output=csv";
    const REFRESH_MS = 600_000; // 10 分鐘
    const DAY_START = 6;  // 06:00
    theDAY_END   = 22; // 到 22:59 都算（含 22）

    function csvUrl() {
      const u = new URL(CSV_BASE);
      u.searchParams.set('gid', SHEET_GID_ALL_CENTERS);
      u.searchParams.set('_ts', Date.now()); // 防快取
      return u.toString();
    }
    document.getElementById('csvLink').href = csvUrl();
    document.getElementById('freqText').textContent = Math.round(REFRESH_MS/1000);

    // 解析台北時區時間（支援 yyyy-MM-dd HH:mm:ss 等）
    function parseTWDateMs(tStr) {
      const opts = { locale: 'zh-TW', zone: 'Asia/Taipei' };
      let dt;
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy-MM-dd HH:mm:ss', opts); if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy-MM-dd HH:mm', opts);    if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d HH:mm:ss', opts);   if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d HH:mm', opts);      if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d a h:mm:ss', opts);  if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromFormat(tStr, 'yyyy/M/d a h:mm', opts);     if (dt.isValid) return dt.toMillis();
      dt = luxon.DateTime.fromISO(tStr, { zone: 'Asia/Taipei' });        if (dt.isValid) return dt.toMillis();
      return NaN;
    }

    // 欄位對應（容錯多種命名 + 去掉 BOM）
    function pick(obj, keysRegex) {
      for (const k of Object.keys(obj)) {
        const nk = k.replace(/\ufeff/g,'').trim();
        if (keysRegex.test(nk)) return obj[k];
      }
      return undefined;
    }
    const RX_TIME   = /(時間|timestamp)/i;
    const RX_CENTER = /(中心|運動中心|館|場館|館別|中心名稱|center)/i;
    const RX_POOL   = /(游泳池|pool|swim)/i;
    const RX_GYM    = /(健身|健身房|gym|weight)/i;

    /** @type {{t:number, center:string, pool:number, gym:number, isoDate:string}[]} */
    let rows = [];
    let currentCenter = DEFAULT_CENTER;  // 預設南屯
    let currentIsoDate = '';             // 例如 '2025-08-14'（台北時區）
    let allCentersMode = false;          // 是否顯示全部中心
    let currentMetric = 'pool';          // 全部中心模式下顯示哪一個指標

    // 彩虹色產生器（HSL）
    function colorHSL(i, total, alpha=1) {
      const h = Math.round((360 * i) / Math.max(1,total));
      return `hsla(${h}, 75%, 60%, ${alpha})`;
    }

    // 建立單一中心兩條線的漸層（更活潑）
    function buildSingleGradients(ctx) {
      const g1 = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
      g1.addColorStop(0, 'rgba(99, 102, 241, .6)'); // indigo-ish
      g1.addColorStop(1, 'rgba(99, 102, 241, 0)');

      const g2 = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
      g2.addColorStop(0, 'rgba(16, 185, 129, .6)'); // emerald-ish
      g2.addColorStop(1, 'rgba(16, 185, 129, 0)');
      return { g1, g2 };
    }

    async function fetchCSV() {
      const res = await fetch(csvUrl(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();

      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      if (parsed.errors?.length) console.warn('CSV parse warnings:', parsed.errors.slice(0,3));

      const tmp = [];
      for (const r of parsed.data) {
        const tStr   = (pick(r, RX_TIME)   ?? '').toString().trim();
        const center = (pick(r, RX_CENTER) ?? '').toString().trim();
        const pool   = Number((pick(r, RX_POOL) ?? '').toString().trim()) || 0;
        const gym    = Number((pick(r, RX_GYM)  ?? '').toString().trim()) || 0;
        const t = parseTWDateMs(tStr);
        if (!center || Number.isNaN(t)) continue;

        // 以台北時區取「日期字串」
        const dt = luxon.DateTime.fromMillis(t).setZone('Asia/Taipei');
        const h  = dt.hour;
        if (h < DAY_START || h > DAY_END) continue;  // 固定只看 06–22
        const isoDate = dt.toISODate(); // yyyy-MM-dd

        tmp.push({ t, center, pool, gym, isoDate });
      }
      tmp.sort((a,b)=>a.t-b.t);
      rows = tmp;

      rebuildCenterSelect();
      rebuildDateSelect();
      ensureDefaults();
      updateHeading();
    }

    function rebuildCenterSelect() {
      const centers = Array.from(new Set(rows.map(r=>r.center))).filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      const sel = document.getElementById('centerSel');
      if (centers.length === 0) {
        sel.innerHTML = `<option value="" disabled selected>（找不到資料）</option>`;
        return;
      }
      sel.innerHTML = centers.map(c=>`<option value="${c}">${c}</option>`).join('');
      if (!centers.includes(currentCenter)) currentCenter = centers[0];
      sel.value = currentCenter;
      sel.disabled = allCentersMode; // 全部中心模式下不可選
    }

    function rebuildDateSelect() {
      // 僅取「目前中心」的可用日期；全部中心模式下也以「目前中心」的日期列表做基準（通常各館日期相同）
      const baseCenter = currentCenter || rows[0]?.center;
      const dates = Array.from(new Set(rows.filter(r=>r.center===baseCenter).map(r=>r.isoDate)))
        .sort((a,b)=> b.localeCompare(a)); // 由新到舊
      const sel = document.getElementById('dateSel');
      if (dates.length === 0) {
        sel.innerHTML = `<option value="" disabled selected>（此中心無資料）</option>`;
        currentIsoDate = '';
        return;
      }
      sel.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
      if (!dates.includes(currentIsoDate)) currentIsoDate = dates[0]; // 預設最新一天
      sel.value = currentIsoDate;
    }

    function ensureDefaults() {
      if (!currentCenter) {
        const any = rows[0]?.center;
        if (any) currentCenter = any;
      }
      if (!currentIsoDate) {
        const any = rows.find(r=>r.center===currentCenter)?.isoDate;
        if (any) currentIsoDate = any;
      }
    }

    // 依中心 + 日期切片（單一中心）
    function sliceForChartSingle() {
      const filtered = rows.filter(r => r.center === currentCenter && r.isoDate === currentIsoDate);
      return {
        times: filtered.map(r=>r.t),
        pool:  filtered.map(r=>r.pool),
        gym:   filtered.map(r=>r.gym),
      };
    }

    // 取得同一天所有中心的資料（全部中心模式）
    function dataForAllCenters(metric='pool') {
      const centers = Array.from(new Set(rows.map(r=>r.center))).filter(Boolean)
        .sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      // 取得此日全域時間軸（取所有點的 union 再排序）
      const times = Array.from(new Set(rows.filter(r=>r.isoDate===currentIsoDate).map(r=>r.t))).sort((a,b)=>a-b);

      // 每個中心對齊時間軸（缺資料補 null）
      const perCenter = centers.map(c=>{
        const map = new Map(rows.filter(r=>r.center===c && r.isoDate===currentIsoDate).map(r=>[r.t, r[metric]]));
        const series = times.map(t => map.has(t) ? map.get(t) : null);
        return { center:c, series };
      });
      return { times, perCenter };
    }

    // 更新頁面主標題
    function updateHeading() {
      const h1 = document.getElementById('pageTitle');
      if (allCentersMode) {
        const metricName = (currentMetric==='pool' ? '游泳池' : '健身房');
        h1.textContent = `台中市各運動中心｜每日人數（全部中心：${metricName}）`;
      } else if (currentCenter) {
        h1.textContent = `${currentCenter}｜每日人數`;
      } else {
        h1.textContent = `台中市各運動中心｜每日人數`;
      }
    }

    let chart;
    function initChart() {
      if (chart) return chart;
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
          responsive: true, maintainAspectRatio: false,
          interaction: { mode:'nearest', intersect:false },
          animation: { duration: 800, easing: 'easeOutQuart' },
          elements: { line: { borderJoinStyle:'round', borderCapStyle:'round' } },
          plugins: {
            legend: { labels: { color:'#e5e7eb' } },
            tooltip: {
              callbacks: {
                title: (items) => items.length
                  ? luxon.DateTime.fromMillis(items[0].parsed.x).setZone('Asia/Taipei').toFormat('yyyy-MM-dd HH:mm:ss')
                  : '',
                label: (item) => {
                  const v = item.parsed.y;
                  return `${item.dataset.label}：${(v==null?'—':v)} 人`;
                }
              }
            }
          },
          scales: {
            x: {
              type:'time',
              time:{ tooltipFormat:'MM/dd HH:mm', displayFormats:{ minute:'HH:mm', hour:'MM/dd HH:mm' } },
              adapters:{ date:{ zone:'Asia/Taipei' } },
              ticks:{ color:'#e5e7eb' }, grid:{ color:'rgba(255,255,255,.08)' }
            },
            y: {
              beginAtZero:true,
              ticks:{ color:'#e5e7eb' }, grid:{ color:'rgba(255,255,255,.08)' },
              title:{ display:true, text:'人數', color:'#e5e7eb' }
            }
          }
        }
      });
      return chart;
    }

    function applyAndRender() {
      const c = initChart();
      const ctx = c.ctx.canvas.getContext('2d');

      if (!allCentersMode) {
        // 單一中心：兩條線（游泳池＋健身房），加面積淡填＋虛線辨識
        const { times, pool, gym } = sliceForChartSingle();
        const { g1, g2 } = buildSingleGradients(ctx);

        c.data.labels = times;
        c.data.datasets = [
          { label: '游泳池人數', data: pool, borderWidth: 3, tension: 0.35, pointRadius: 2, pointHoverRadius: 5,
            borderColor: 'rgba(99,102,241,1)', backgroundColor: g1, fill: 'origin' },
          { label: '健身房人數', data: gym,  borderWidth: 3, tension: 0.35, pointRadius: 2, pointHoverRadius: 5,
            borderColor: 'rgba(16,185,129,1)', backgroundColor: g2, fill: 'origin', borderDash:[6,6] }
        ];
        c.update();

        // Header 數字
        if (times.length) {
          document.getElementById('poolNow').textContent = pool[pool.length-1];
          document.getElementById('gymNow').textContent  = gym[gym.length-1];
          document.getElementById('lastUpd').textContent =
            luxon.DateTime.fromMillis(times[times.length-1]).setZone('Asia/Taipei').toFormat('yyyy-MM-dd HH:mm:ss');
        } else {
          document.getElementById('poolNow').textContent = '—';
          document.getElementById('gymNow').textContent  = '—';
          document.getElementById('lastUpd').textContent = '—';
        }
      } else {
        // 全部中心：每個中心一條線（只選一種指標），自動彩色
        const metricName = currentMetric==='pool' ? '游泳池' : '健身房';
        const { times, perCenter } = dataForAllCenters(currentMetric);

        c.data.labels = times;
        c.data.datasets = perCenter.map((row, i, arr) => {
          const col = colorHSL(i, arr.length, 1);
          const fillCol = colorHSL(i, arr.length, .18);
          return {
            label: row.center + '（' + metricName + '）',
            data: row.series,
            borderColor: col,
            backgroundColor: fillCol,
            borderWidth: 2.5,
            pointRadius: 0,
            pointHoverRadius: 4,
            tension: 0.3,
            spanGaps: true, // 缺資料時不中斷軸
          };
        });
        c.update();

        // 多中心模式下頁首當前數字不具代表性，改為 —
        document.getElementById('poolNow').textContent = '—';
        document.getElementById('gymNow').textContent  = '—';
        if (times.length) {
          document.getElementById('lastUpd').textContent =
            luxon.DateTime.fromMillis(times[times.length-1]).setZone('Asia/Taipei').toFormat('yyyy-MM-dd HH:mm:ss');
        } else {
          document.getElementById('lastUpd').textContent = '—';
        }
      }
    }

    async function refresh() {
      try {
        await fetchCSV();
        applyAndRender();
        document.getElementById('csvLink').href = csvUrl(); // 更新附帶 _ts 的 CSV 連結
      } catch (e) {
        console.error(e);
      }
    }

    // 綁定 UI
    document.getElementById('centerSel').addEventListener('change', (e)=>{
      currentCenter = e.target.value;
      updateHeading();
      rebuildDateSelect();   // 依中心重建日期清單
      applyAndRender();
    });
    document.getElementById('dateSel').addEventListener('change', (e)=>{
      currentIsoDate = e.target.value;
      applyAndRender();
    });

    const allModeEl = document.getElementById('allMode');
    const metricBox = document.getElementById('metricBox');
    const metricSel = document.getElementById('metricSel');

    allModeEl.addEventListener('change', ()=>{
      allCentersMode = allModeEl.checked;
      document.getElementById('centerSel').disabled = allCentersMode;
      metricBox.style.display = allCentersMode ? 'inline-flex' : 'none';
      updateHeading();
      applyAndRender();
    });

    metricSel.addEventListener('change', (e)=>{
      currentMetric = e.target.value; // pool | gym
      updateHeading();
      applyAndRender();
    });

    // 初始化
    currentCenter = DEFAULT_CENTER; // 進站先鎖定南屯
    updateHeading();
    initChart();
    refresh();
    setInterval(refresh, REFRESH_MS);
  </script>
</body>
</html>
